{% extends 'front/base.html' %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.7.4/css/uikit.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
<title>{{settings.title}}</title>

<div class="gallery">
    <h2 class="uk-text-bolder footer uk-animation-fade">{{ settings.title_delimiter }} Edit {{ album.name }} {{ settings.title_delimiter }}</h2>
    <div class="uk-child-width-1-5@m uk-text-center uk-grid-small" uk-grid="masonry: false" uk-lightbox="animation: slide" id="image-grid">
        {% for image in images %}
        <div class="image-item" data-image-id="{{ image.id }}" data-image-order="{{ image.order }}">
            <a href="{{ image.image.url }}" data-caption="{{image.name}}">
                <div class="uk-card uk-card-default uk-card-body card-md" style="background-image: url({{ image.thumbnail.url }});">
                    <div class="drag-handle" style="cursor: move;font-size:24pt;">DRAG</div>
                </div>
            </a>
            <button class="visibility-button" data-photo-id="{{ image.id }}">
                {% if image.status %}
                Hide image
                {% else %}
                Show image
                {% endif %}
            </button> |
            <label for="form-select" style="font-size:10pt;">Change Album: </label>
            <select class="form-select" name="album" data-photo-id="{{ image.id }}">
                {% for album in albums %}
                <option value="{{ album.id }}">{{ album.name }}</option>
                {% endfor %}
            </select> |
            <input type="text" class="photo-name-input" data-photo-id="{{ image.id }}" value="{{ image.name }}">
            <button class="save-button" data-photo-id="{{ image.id }}">Change name</button>
        </div>
        {% endfor %}
    </div>
</div>
<style>
    .hidden-image {
  filter: brightness(50%);
}
</style>
<script>
$(document).on('click', '.visibility-button', function(event) {
    var button = $(this); // Save reference to the button

    var imageId = button.data('photo-id');
    var visibility = !button.text().includes('Hide');

    $.ajax({
        url: '/sys/images/' + imageId + '/change_visibility',
        method: 'POST',
        data: {
            'csrfmiddlewaretoken': "{{ csrf_token }}",
            'visibility': visibility
        },
        success: function(data) {
            if (data.success) {
                // Update the button text using the saved reference
                button.text(visibility ? 'Hide image' : 'Show image');

                // Get the parent container of the button, which contains the image
                var imageContainer = button.closest('.image-item');

                // Add or remove the .hidden-image class based on the visibility
                if (visibility) {
                    imageContainer.css('filter', 'none'); // Remove the filter when the image is shown
                } else {
                    imageContainer.css('filter', 'blur(1px)'); // Add the filter when the image is hidden
                }
            }
        }
    });
});

// On page load, apply the filter to the image items with the button text "Show image"
$(document).ready(function() {
    $('.visibility-button:contains("Show image")').each(function() {
        var imageItem = $(this).closest('.image-item');
        imageItem.css('filter', 'blur(1px)');
    });
});
</script>
<script>
$(document).ready(function() {
    $('.image-item').on('change', '.form-select', function(event) {
        event.preventDefault();

        var photoId = $(this).data('photo-id');
        var albumId = $(this).val();

        $.ajax({
            url: '/sys/change_album/' + photoId + '/' + albumId,
            type: 'POST',
            data: {
            'csrfmiddlewaretoken': "{{ csrf_token }}",
            'album': albumId,
            },
            success: function(data) {
                if (data.success) {
                    alert('Album changed successfully!');
                } else {
                    alert('An error occurred.');
                }
            }
        });
    });
});
</script>
<script>
$(document).ready(function() {
    $('.photo-name-input').on('change', function() {
        var photoId = $(this).data('photo-id');
        var newName = $(this).val();
        $.ajax({
            url: '/sys/update_image_name/' + photoId,
            type: 'POST',
            data: {
                name: newName,
                'csrfmiddlewaretoken': "{{ csrf_token }}"
            },
            success: function(data) {
                if (data.success) {
                    alert('Image name changed successfully!');
                } else {
                    alert('An error occurred.');
                }
            }
        });
    });
});
</script>
<script>
$(document).ready(function () {
    $("#image-grid").sortable({
        handle: ".drag-handle",
        update: function (event, ui) {
            var imageOrderData = [];
            $(this).children().each(function (index) {
                var imageId = $(this).data("image-id");
                var newOrder = index + 1;
                imageOrderData.push({
                    id: imageId,
                    order: newOrder,
                });
            });
            // Send the updated order data to the server using AJAX
            $.ajax({
                type: "POST",
                url: "{% url 'update_image_order' %}",
                data: {
                    images: JSON.stringify(imageOrderData),
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                },
                success: function (response) {
                    // Handle any success response from the server
                    console.log("Image order updated successfully!");
                },
                error: function (xhr) {
                    // Handle any error response from the server
                    console.log("Error updating image order: " + xhr.status);
                },
            });
        },
    });
});
</script>
{% endblock %}
{% block copyright %}
{{settings.copyright}}
{% endblock %}
